name: Version, Build (Linux/Windows), and Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: build-release-main-${{ github.ref }}
  cancel-in-progress: true

jobs:
  #version-bump:
    #name: Version bump and output version
    #runs-on: ubuntu-latest
    #permissions:
      #contents: write
    #outputs:
      #version: ${{ steps.bump.outputs.version }}
    #steps:
      #- name: Checkout repository
        #uses: actions/checkout@v4
        #with:
          #fetch-depth: 0

      #- name: Determine bump type and update Cargo.toml
        #id: bump
        #shell: bash
        #run: |
          #set -euo pipefail
          ## 1) Read current version from top-level "version" in Cargo.toml
          #CURR_VERSION="$(awk -F\" '/^version *= *\"[0-9]+\.[0-9]+\.[0-9]+\"/ {print $2; exit}' Cargo.toml)"
          #if [ -z "${CURR_VERSION:-}" ]; then
            #echo "Unable to find current version in Cargo.toml" >&2
            #exit 1
          #fi
          #echo "Current version: $CURR_VERSION"

          ## 2) Detect bump type from triggering commit message (default: patch)
          #MSG="${{ github.event.head_commit.message }}"
          #MSG_LOWER="$(printf "%s" "$MSG" | tr '[:upper:]' '[:lower:]')"
          #BUMP=patch
          #if echo "$MSG_LOWER" | grep -q "\[major\]"; then
            #BUMP=major
          #elif echo "$MSG_LOWER" | grep -q "\[minor\]"; then
            #BUMP=minor
          #elif echo "$MSG_LOWER" | grep -q "\[patch\]"; then
            #BUMP=patch
          #fi
          #echo "Bump type: $BUMP"

          ## 3) Compute new semver
          #IFS='.' read -r MAJ MIN PAT <<< "$CURR_VERSION"
          #case "$BUMP" in
            #major)
              #((MAJ=MAJ+1)); MIN=0; PAT=0;;
            #minor)
              #((MIN=MIN+1)); PAT=0;;
            #patch)
              #((PAT=PAT+1));;
          #esac
          #NEW_VERSION="${MAJ}.${MIN}.${PAT}"
          #echo "New version: $NEW_VERSION"

          ## 4) Update Cargo.toml (first occurrence of a top-level version line)
          #sed -i -E "0,/^version *= *\"[0-9]+\.[0-9]+\.[0-9]+\"/s//version = \"${NEW_VERSION}\"/" Cargo.toml

          ## 5) Verify update
          #UPDATED="$(awk -F\" '/^version *= *\"[0-9]+\.[0-9]+\.[0-9]+\"/ {print $2; exit}' Cargo.toml)"
          #if [ "$UPDATED" != "$NEW_VERSION" ]; then
            #echo "Failed to update Cargo.toml (found: $UPDATED)" >&2
            #exit 1
          #fi

          ## 6) Export new version for downstream jobs
          #echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      #- name: Commit version bump
        #if: ${{ steps.bump.outputs.version != '' }}
        #run: |
          #set -euo pipefail
          #git config user.name "github-actions[bot]"
          #git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          #git add Cargo.toml
          #git commit -m "chore: bump version to ${{ steps.bump.outputs.version }} [skip ci]" || echo "No changes to commit"

      #- name: Push changes
        #if: ${{ steps.bump.outputs.version != '' }}
        #run: |
          #set -euo pipefail
          #git push origin HEAD:main

  build-linux:
    name: Linux build (Nix)
    runs-on: ubuntu-latest
    #needs: version-bump
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build with Nix
        run: nix build

      - name: Collect Linux executables
        run: |
          set -euo pipefail
          # Check for client executable (default package)
          if [ -x result/bin/client ]; then
            cp -L result/bin/client bevy2025-client-linux
            chmod +x bevy2025-client-linux
          fi
          # Also check for server if it exists in the default build
          if [ -x result/bin/server ]; then
            cp -L result/bin/server bevy2025-server-linux
            chmod +x bevy2025-server-linux
          fi
          # Fallback: check for bevy2025 (legacy name)
          if [ -x result/bin/bevy2025 ]; then
            cp -L result/bin/bevy2025 bevy2025-linux
            chmod +x bevy2025-linux
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-executables
          path: |
            bevy2025-client-linux
            bevy2025-server-linux
            bevy2025-linux
          if-no-files-found: warn
          retention-days: 7

  build-wasm:
    name: Build and push WASM container
    runs-on: ubuntu-latest
    #needs: version-bump
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build container with Nix
        run: nix build .#staticWebserver

      - name: Install skopeo
        run: sudo apt-get install -y skopeo

      - name: Push container with skopeo
        run: |
          set -euo pipefail
          skopeo login --username ${{ github.actor }} --password "${{ secrets.GITHUB_TOKEN }}" ghcr.io
          ls -la ./result
          RESULT=$(readlink -f ./result)
          echo "Result path: $RESULT"
          IMAGE_TAG=$(date +%Y%m%d_%H%M)
          skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:webserver-wasm-${IMAGE_TAG}
          # if not pull request, then also push as latest
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:webserver-wasm-branch-${{ github.head_ref }}
          else
            skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:webserver-wasm-latest
          fi

  build-container:
    name: Build and push container
    runs-on: ubuntu-latest
    #needs: version-bump
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build container with Nix
        run: nix build .#container

      - name: Install skopeo
        run: sudo apt-get install -y skopeo

      - name: Push container with skopeo
        run: |
          set -euo pipefail
          skopeo login --username ${{ github.actor }} --password "${{ secrets.GITHUB_TOKEN }}" ghcr.io
          ls -la ./result
          RESULT=$(readlink -f ./result)
          echo "Result path: $RESULT"
          IMAGE_TAG=$(date +%Y%m%d_%H%M)
          skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:gameserver-${IMAGE_TAG}
          # if not pull request, then also push as latest
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:gameserver-branch-${{ github.head_ref }}
          else
            skopeo copy docker-archive://$RESULT docker://ghcr.io/2143-labs/bevy2025:gameserver-latest
          fi

  build-windows:
    name: Windows build (cargo)
    runs-on: windows-latest
    #needs: version-bump
    permissions:
      contents: read
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: sccache
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run sccache-cache
        if: ${{ !github.event.act }}
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Collect Windows executable
        shell: pwsh
        run: |
          Copy-Item "target\release\client.exe" "bevy2025-client-windows.exe"
          Copy-Item "target\release\server.exe" "bevy2025-server-windows.exe"

      - name: Upload Windows artifact client
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable-client
          path: bevy2025-client-windows.exe
          if-no-files-found: error

      - name: Upload Windows artifact server
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable-server
          path: bevy2025-server-windows.exe
          if-no-files-found: error


  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-windows
    # Only create releases on main branch pushes, not PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: dist

      - name: Create tag name and version name
        id: version-info
        run: |
          echo "TAG_NAME=v${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version-info.outputs.TAG_NAME }}
          name: Release ${{ steps.version-info.outputs.TAG_NAME }}
          draft: false
          prerelease: false
          target_commitish: main
          files: |
            dist/bevy2025-client-windows.exe
            dist/bevy2025-server-windows.exe
            dist/bevy2025-client-linux
            dist/bevy2025-server-linux
            dist/bevy2025-linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
